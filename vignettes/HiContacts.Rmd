---
title: "Introduction to HiContacts"
author: "Jacques Serizay"
date: "`r Sys.Date()`"
output: 
    BiocStyle::html_document
vignette: >
    %\VignetteIndexEntry{Introduction to HiContacts}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
---

```{r, eval = TRUE, echo=FALSE, results="hide", warning=FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
suppressPackageStartupMessages({
    library(ggplot2)
    library(dplyr)
    library(GenomicRanges)
    library(HiContactsData)
    library(HiContacts)
})
```

HiContacts provides tools to import `(m)cool` matrices in R and work with 
them there. 

It creates a new `contacts` class of objects, built on pre-existing 
Bioconductor objects, namely `InteractionSet`, `GenomicInterations` 
and `ContactMatrix` (`Lun, Perry & Ing-Simmons, F1000Research 2016`), 
and provides **analytical** and **visualization** tools to investigate 
contact maps. 

## Import a .(m)cool file as `contacts`

The `HiContactsData` package gives access to a range of toy datasets stored 
by Bioconductor in the `ExperimentHub`. 

```{r}
library(HiContactsData)
cool_file <- HiContactsData('yeast_wt', format = 'cool')
cool_file
```

The `contacts()` function can be used to import a Hi-C matrix locally stored 
as a cool/mcool file.  

```{r}
library(ggplot2)
library(dplyr)
library(GenomicRanges)
library(HiContacts)
range <- 'I:20000-80000' # range of interest
contacts <- contacts(cool_file, focus = range)
contacts
```

`cool2gi` works with `.mcool` files as well: in this case, the user needs to 
specify the resolution at which count values are recovered. 

```{r}
mcool_file <- HiContactsData('yeast_wt', format = 'mcool')
range <- 'II:0-800000' # range of interest
lsCoolResolutions(mcool_file)
# contacts <- contacts(mcool_file, focus = range) # This would throw an error!
contacts <- contacts(mcool_file, focus = range, res = 1000)
contacts
```

## Plotting matrices 

### Plot matrix heatmaps

```{r}
## Matrix centered over diagonal 
contacts <- contacts(mcool_file, focus = 'II:0-800000', res = 1000)
plotMatrix(contacts, use.scores = 'raw')
plotMatrix(contacts, use.scores = 'balanced', limits = c(-4, -1))

## Uncentered matrix
contacts <- contacts(mcool_file, focus = 'II:0-500000 x II:100000-600000', res = 1000)
plotMatrix(contacts, use.scores = 'balanced', limits = c(-4, -1))
```

### Plot loops

```{r}
mcool_file <- HiContactsData('yeast_wt', format = 'mcool')
loops <- system.file("extdata", 'S288C-loops.bedpe', package = 'HiContacts') %>% 
    rtracklayer::import() %>% 
    InteractionSet::makeGInteractionsFromGRangesPairs()
contacts(mcool_file, focus = 'IV', res = 1000) %>% 
    detrend() %>% 
    plotMatrix(use.scores = 'detrended', loops = loops, scale = 'linear', limits = c(-2, 2))
```

### Plot borders

```{r}
borders <- system.file("extdata", 'S288C-borders.bed', package = 'HiContacts') %>% 
    rtracklayer::import()
contacts(mcool_file, focus = 'IV', res = 1000) %>% 
    detrend() %>% 
    plotMatrix(use.scores = 'detrended', loops = loops, borders = borders, scale = 'linear', limits = c(-2, 2))
```

## Arithmetics

### Subsetting a contact map 

```{r}
mcool_file <- HiContactsData('yeast_wt', format = 'mcool')
contacts <- contacts(mcool_file, focus = 'II', res = 2000)
contacts_subset <- contacts[
    start(anchors(contacts)[[1]]) < 300000 & end(anchors(contacts)[[1]]) < 300000 & 
    start(anchors(contacts)[[2]]) < 300000 & end(anchors(contacts)[[2]]) < 300000
]
cowplot::plot_grid(
    plotMatrix(contacts, use.scores = 'balanced', scale = 'log10', limits = c(-4, -1)),
    plotMatrix(contacts_subset, use.scores = 'balanced', scale = 'log10', limits = c(-4, -1))
)
```

### Computing autocorrelated contact map 

```{r}
mcool_file <- HiContactsData('mESCs', format = 'mcool')
contacts <- contacts(mcool_file, focus = 'chr2', res = 160000)
contacts %>% 
    autocorrelate(ignore_ndiags = 20) %>% 
    plotMatrix(scale = 'linear', limits = c(-1, 1))
```

### Detrending contact map (map over expected)

```{r}
mcool_file <- HiContactsData('mESCs', format = 'mcool')
contacts <- contacts(mcool_file, focus = 'chr18:20000000-35000000', res = 40000)
detrended_contacts <- detrend(contacts)
cowplot::plot_grid(
    plotMatrix(contacts, use.scores = 'balanced', limits = c(-4, -1)),
    plotMatrix(detrended_contacts, use.scores = 'expected'),
    plotMatrix(detrended_contacts, use.scores = 'detrended', scale = 'linear', limits = c(-3, 3))
)
```

### Summing two maps

```{r}
mcool_file_1 <- HiContactsData('yeast_eco1', format = 'mcool')
mcool_file_2 <- HiContactsData('yeast_wt', format = 'mcool')
contacts_1 <- contacts(mcool_file_1, focus = 'II', res = 2000)
contacts_1 <- contacts_1[
    start(anchors(contacts_1)[[1]]) < 300000 & end(anchors(contacts_1)[[1]]) < 300000 & 
    start(anchors(contacts_1)[[2]]) < 300000 & end(anchors(contacts_1)[[2]]) < 300000
]
contacts_2 <- contacts(mcool_file_2, focus = 'II', res = 2000)
contacts_2 <- contacts_2[
    start(anchors(contacts_2)[[1]]) > 500000 & end(anchors(contacts_2)[[1]]) > 500000 & 
    start(anchors(contacts_2)[[2]]) > 500000 & end(anchors(contacts_2)[[2]]) > 500000
]
merged_contacts <- merge(contacts_1, contacts_2) 
merged_contacts
cowplot::plot_grid(
    plotMatrix(contacts_1, use.scores = 'balanced', scale = 'log10', limits = c(-4, -1)),
    plotMatrix(contacts_2, use.scores = 'balanced', scale = 'log10', limits = c(-4, -1)),
    plotMatrix(merged_contacts, use.scores = 'balanced', scale = 'log10', limits = c(-4, -1))
)
```

### Computing ratio between two maps

```{r}
mcool_file_1 <- HiContactsData('yeast_eco1', format = 'mcool')
mcool_file_2 <- HiContactsData('yeast_wt', format = 'mcool')
contacts_1 <- contacts(mcool_file_1, focus = 'II', res = 2000)
contacts_2 <- contacts(mcool_file_2, focus = 'II', res = 2000)
div_contacts <- divide(contacts_1, by = contacts_2) 
div_contacts
cowplot::plot_grid(
    plotMatrix(contacts_1, use.scores = 'balanced', scale = 'log10', limits = c(-4, -1)),
    plotMatrix(contacts_2, use.scores = 'balanced', scale = 'log10', limits = c(-4, -1)),
    plotMatrix(div_contacts, use.scores = 'ratio', scale = 'log2', limits = c(-2, 2), cmap = bwr_colors())
)
```

## Contact map analysis

### Virtual 4C

```{r}
mcool_file <- HiContactsData('mESCs', format = 'mcool')
contacts <- contacts(mcool_file, focus = 'chr18:20000000-35000000', res = 40000)
v4C <- virtual4C(contacts, viewpoint = GRanges('chr18:31000000-31050000'))
cowplot::plot_grid(
    plot4C(v4C, aes(x = center, y = score)), 
    plotMatrix(contacts, use.scores = 'balanced', limits = c(-4, -1)), 
    ncol = 1, align = 'hv', axis = 'tblr'
)
```

### Cis-trans ratios

```{r}
mcool_file <- HiContactsData('yeast_wt', format = 'mcool')
contacts <- contacts(mcool_file, res = 1000)
cis_trans(contacts)
```

### P(s)

```{r}
# Without a pairs file
mcool_file <- HiContactsData('yeast_wt', format = 'mcool')
contacts <- contacts(mcool_file, res = 1000)
ps <- getPs(contacts)
plotPs(ps, aes(x = binned_distance, y = norm_p))

# With a pairs file
pairsFile(contacts) <- HiContactsData('yeast_wt', format = 'pairs.gz')
ps <- getPs(contacts)
plotPs(ps, aes(x = binned_distance, y = norm_p))
plotPsSlope(ps, aes(x = binned_distance, y = slope))

# Comparing P(s) curves
c1 <- contacts(
    HiContactsData('yeast_wt', format = 'mcool'), 
    res = 1000, 
    pairs = HiContactsData('yeast_wt', format = 'pairs.gz')
)
c2 <- contacts(
    HiContactsData('yeast_eco1', format = 'mcool'), 
    res = 1000, 
    pairs = HiContactsData('yeast_eco1', format = 'pairs.gz')
)
ps_1 <- getPs(c1) %>% mutate(sample = 'WT')
ps_2 <- getPs(c2) %>% mutate(sample = 'Eco1-AID')
ps <- rbind(ps_1, ps_2)
plotPs(ps, aes(x = binned_distance, y = norm_p, group = sample, color = sample))
plotPsSlope(ps, aes(x = binned_distance, y = slope, group = sample, color = sample))
```

### Aggregated Plot Analysis (APA)

```{r}
## TBD
```

### Scalograms

```{r}
## TBD
```

## Session info

```{r}
sessionInfo()
```
